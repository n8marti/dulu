<h2>
  <%= @person.full_name %>
  <% if can? :update, @person %>
    <%= link_to t(:Edit), edit_person_path(@person), class: 'btn btn-warning hdr-btn' %>
  <% end %>
</h2>
<h4><%= @person.organization.try(:name) %></h4>

<table class="table" style="width:auto;">
  <tr>
    <th><%= t :Home_Country %></th>
    <td><%= @person.country.try(:name) %></td>
  </tr>
  <tr>
    <th><%= t :Email %></th>
    <td><%= @person.email %></td>
  </tr>
  <tr>
    <th>Dulu</th>
    <td><%= @person.has_login ? t(:Can_log_in) : t(:No_login) %></td>
  </tr>
</table>

<div class="showable-form-section">
  <% grantable_roles = Role.grantable_roles(current_user, @person) %>
  <h3>
    <%= t :Roles %>
    <% if can?(:update, @person) && !grantable_roles.empty? %>
      <small>
        <a href="#" data-showable-form-show><%= @person.roles_field.blank? ? t(:Add) : t(:Edit) %></a>
        <a href="#" data-showable-form-hide class="not-shown"><%= t(:Cancel) %></a>
      </small>
    <% end %>
  </h3>

  <% if @person.roles_field.blank? %>
    <p class="shown">
      <%= t(:None) %>
    </p>
  <% else %>
    <table class="table" style="width: auto;" id="roles-table">
      <tr>
        <th><%= t :Role %></th>
        <th><%= t :As_of %></th>
        <th>
        </th>
      </tr>
      <% @person.person_roles.current.each do |person_role| %>
        <tr>
          <td><%= t person_role.role %></td>
          <td><%= l(person_role.start_date, format: :full) %></td>
          <td class="not-shown">
            <%= link_to t(:Remove), finish_person_person_role_path(@person, person_role.role), method: :post %>
          </td>
        </tr>
      <% end %>
    </table>
  <% end %>

  <p>
    <% unless grantable_roles.empty? %>
      <%= form_for :person_role, url: person_person_roles_path(@person), html: {class: 'form-inline not-shown'} do |form| %>
        <div class="form-group">
          <label><%= t :Add_role %></label>
          <%= form.select :role, grantable_roles.collect{ |role| [t(role), role] }.sort, {}, class: 'form-control'  %>
        </div>
        <div class="form-group">
          <%= form.submit t(:Add), class: 'btn btn-primary' %>
          <a href="#" data-showable-form-hide class="btn btn-danger"><%= t :Cancel %></a>
        </div>
      <% end %>
    <% end %>
  </p>
</div>


<% participants = @person.current_participants %>
<% unless participants.empty? %>
  <h3>
    <%= t :Current_programs %>
  </h3>
  <table class="table auto-width">
    <% participants.each do |participant| %>
      <tr>
        <td class="bigger">
          <%= link_to participant.cluster_program.display_name, participant.cluster_program %>
        </td>
        <td>
          <%= participant.roles_text %>
        </td>
      </tr>
    <% end %>
  </table>
<% end %>

<% participants = @person.participants.where('end_date IS NOT NULL') %>
<% unless participants.empty? %>
  <h3>
    <%= t :Previous_programs %>
  </h3>
  <table class="table auto-width">
    <% participants.each do |participant| %>
      <tr>
        <td class="bigger">
          <%= link_to participant.cluster_program.display_name, participant.cluster_program %>
        </td>
        <td>
          <%= participant.roles_text %>
        </td>
      </tr>
    <% end %>
  </table>
<% end %>

<%
  future_events = @person.events.upcoming
  current_events = @person.events.current
  past_events = @person.events.past.limit(5)
%>
<% unless future_events.empty? and current_events.empty? and past_events.empty? %>
  <h3><%= t :Events %></h3>
  <table class="table auto-width">
    <% [future_events, current_events, past_events].each_with_index do |events, i| %>
      <% events.each do |event| %>
        <% tr_class = (i==2) ? "class='text-muted'".html_safe : "" %>
        <tr <%= tr_class %>>
          <td class="bigger"><%= link_to event.name, event %></td>
          <td><%= event.dates_display_text %></td>
          <td class="subtle-links">
            <%= event.cluster_programs.collect do |cp| %>
              <% link_to(cp.display_name, cp) %>
            <% end.join(', ').html_safe %>
          </td>
        </tr>
      <% end %>
    <% end %>
  </table>
<% end %>